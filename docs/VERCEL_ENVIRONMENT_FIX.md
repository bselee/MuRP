# Vercel Environment Configuration Fix

**Date:** December 13, 2025  
**Issue:** Deployments going to preview instead of production  
**Status:** ‚úÖ Fixed

---

## üêõ Problem

The `.env.production` file in the repository contained a `VERCEL_OIDC_TOKEN` that was scoped for the **development environment** instead of production. This caused confusion in deployment routing.

### Root Cause

When decoded, the JWT token revealed:
```json
{
  "environment": "development",
  "scope": "owner:will-selees-projects:project:tgf-mrp:environment:development",
  "project": "tgf-mrp",
  ...
}
```

The token was likely generated by running `vercel env pull` for the development environment and then mistakenly committed to the `.env.production` file.

---

## ‚úÖ Solution

**Removed `VERCEL_OIDC_TOKEN` from `.env.production`**

### Why This Fix Works

1. **`VERCEL_OIDC_TOKEN` is auto-injected:** Vercel automatically provides this token during deployment
2. **Environment-specific:** Each deployment environment (preview, production) gets the correct token automatically
3. **Should not be committed:** This token should never be in version control

### Changes Made

```diff
 SUPABASE_URL="https://mpuevsmtowyexhsqugkm.supabase.co"
-VERCEL_OIDC_TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6Im1yay00MzAyZWMxYjY3MGY0OGE5OGFkNjFkYWRlNGEyM2JlNyJ9..."
+# VERCEL_OIDC_TOKEN is automatically injected by Vercel during deployment
+# Do not manually set this - Vercel provides the correct token for each environment
```

---

## üîç How Vercel Environments Work

### Automatic Environment Variables

Vercel provides these environment variables automatically during builds:

| Variable | Description | Auto-injected? |
|----------|-------------|----------------|
| `VERCEL_ENV` | Current environment: `production`, `preview`, or `development` | ‚úÖ Yes |
| `VERCEL_URL` | Deployment URL | ‚úÖ Yes |
| `VERCEL_OIDC_TOKEN` | Authentication token with environment scope | ‚úÖ Yes |
| `VERCEL_GIT_COMMIT_SHA` | Git commit hash | ‚úÖ Yes |

### Manual Environment Variables

Variables you configure in Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables:
- API keys (Gemini, Stripe, etc.)
- Database credentials (Supabase)
- Third-party service credentials (Finale, Google OAuth)

---

## üìã Best Practices

### ‚úÖ DO

1. **Configure secrets in Vercel Dashboard** for each environment
2. **Use `.env.example`** for documentation
3. **Trust Vercel's automatic variables** - don't override them
4. **Test locally** with `.env.local` (git-ignored)

### ‚ùå DON'T

1. **Don't commit** `.env.local`, `.env.development.local`, etc.
2. **Don't manually set** `VERCEL_*` environment variables
3. **Don't mix** development tokens in production files
4. **Don't commit** sensitive API keys or tokens

---

## üöÄ Deployment Checklist

When deploying to production:

- [ ] All environment variables configured in Vercel Dashboard ‚Üí Production
- [ ] No `VERCEL_*` variables manually set in `.env` files
- [ ] `.gitignore` properly excludes `.env.local`, `.env.*.local`
- [ ] Build succeeds: `npm run build`
- [ ] Deploy: `vercel --prod` or merge to `main` branch

---

## üîó References

- [Vercel Environment Variables Docs](https://vercel.com/docs/projects/environment-variables)
- [Vercel System Environment Variables](https://vercel.com/docs/projects/environment-variables/system-environment-variables)
- [OIDC Token Documentation](https://vercel.com/docs/security/secure-backend-access/oidc)

---

## üìù Related Files

- `.env.production` - Production environment variables (committed)
- `.env.example` - Template for local development
- `.env.local.example` - Extended template with all options
- `vercel.json` - Vercel configuration
- `.gitignore` - Ensures local env files not committed

---

## ‚ö†Ô∏è Security Note

**Current State:** The `.env.production` file is committed to the repository and contains sensitive credentials (Supabase keys, database passwords). 

**Recommendation:** For improved security, consider:
1. Moving sensitive credentials to Vercel Dashboard ‚Üí Environment Variables
2. Keeping only non-sensitive configuration in `.env.production`
3. Adding `.env.production` to `.gitignore` and providing `.env.production.example` instead

This would follow security best practices and prevent accidental credential exposure.

---

**Commit:** `fix: remove development-scoped VERCEL_OIDC_TOKEN from .env.production`
